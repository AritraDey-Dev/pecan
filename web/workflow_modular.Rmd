---
title: "PEcAn Modular Workflow"
author: "Aritra Dey"
date: "`r Sys.Date()`"
output: html_document
---

```{r libraries}
library("PEcAn.all")
```

```{r load-settings}

settings_path <- "settings.xml" 
settings <- PEcAn.settings::read.settings(settings_path)
settings <- PEcAn.utils::do_conversions(settings)

if (is.null(settings$debug)) {
  settings$debug <- FALSE  # Default to FALSE if not defined
}
```


```{r trait-analysis}
if (settings$debug) cat("Starting trait analysis...\n")

settings <- PEcAn.workflow::runModule.get.trait.data(settings)
PEcAn.settings::write.settings(settings, outputfile = "pecan.TRAIT.xml")

```

```{r meta-analysis}
if (settings$debug) cat("Starting meta-analysis...\n")
settings <- runModule.get.trait.data(settings)
runModule.run.meta.analysis(settings)
```

```{r run.write.configs}
settings <- runModule.run.write.configs(settings)
```

```{r run-model}
runModule.start.model.runs(settings)
runModule.get.results(settings)
```

```{r model-analysis}
run.sensitivity.analysis()      # Run sensitivity analysis and variance decomposition on model output
run.ensemble.analysis()  	      # Run ensemble analysis on model output. 
run.ensemble.analysis(plot.timeseries=TRUE) 
```

```{r finish}
if (settings$debug) {
    cat("Workflow completed successfully\n")
}
```
