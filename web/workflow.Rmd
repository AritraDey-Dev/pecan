---
title: "PEcAn Modular Workflow"
author: "Aritra Dey"
date: "`r Sys.Date()`"
output: html_document
---

# Load PEcAn packages
```{r libraries}
library("PEcAn.all")
```
# Load PEcAn settings files.

Open and read in settings file for PEcAn run.
To create a pecan.xml, you can download one generated in the PEcAn web interface or one of the `pecan.<modelname>.xml` files in the tests/ directory of 
the PEcAn repository (github.com/pecanproject/pecan).
```{r load-settings}

settings_path <- "settings.xml" 
settings <- PEcAn.settings::read.settings(settings_path)
```


```{r prepare-settings}
# Prepare and check settings
settings$outdir <- "/home/carya/pecan_runs"
settings <- PEcAn.settings::prepare.settings(settings)
```

```{r convert-settings}
# Convert settings to required units
if (!is.list(settings$host) || length(settings$host) > 1) {
settings$host <- list(name = as.character(settings$host)[1]) # Ensure single-element list
}
settings <- PEcAn.workflow::do_conversions(settings)
```

# Trait and Meta Analysis
Fetches plant trait data and prior distributions from external databases for the specified Plant Functional Types (PFTs), then combines trait data across multiple sources to derive probabilistic distributions for model parameters.
If this step is skipped, a posterior file should be specified in the settings.

```{r meta-analysis}
if (settings$debug) cat("Starting trait and meta-analysis...\n")
# Retrieve trait data and prior distributions for the specified Plant Functional Types (PFTs)
settings <- PEcAn.workflow::runModule.get.trait.data(settings)
# Perform meta-analysis to derive probabilistic distributions for model parameters
PEcAn.workflow::runModule.run.meta.analysis(settings)
# Save the updated settings, including the retrieved trait data, to an XML file
PEcAn.settings::write.settings(settings, outputfile = "pecan.TRAIT.xml")

```



# Write Model Configuration Files
Generates model-specific configuration files based on the settings, ensuring proper model execution.

```{r run.write.configs}
settings$model$binary <- "~/pecan/models/sipnet/" # Path to model binary,change it according to your models if ed2 mention ed2 binary path
settings <-PEcAn.workflow::runModule.run.write.configs(settings)
PEcAn.settings::write.settings(settings, outputfile = "pecan.CONFIGS.xml")
```


# Run Model and Retrieve Results
Executes the model simulations and retrieves the results for further analysis.

```{r run-model}
if (!is.list(settings$host) || length(settings$host) > 1) {
settings$host <- list(name = as.character(settings$host)[1]) 
}
PEcAn.workflow::start_model_runs(settings)
```

# Model Analyses
Performs various analyses on model outputs, including sensitivity analysis, variance decomposition, and ensemble analysis.

```{r model-analysis}
runModule.get.results(settings)
run.sensitivity.analysis(settings)      # Run sensitivity analysis and variance decomposition on model output
run.ensemble.analysis(settings)  	      # Run ensemble analysis on model output. 
run.ensemble.analysis(plot.timeseries=TRUE) 
```

