# PEcAn Modular Workflow

The **PEcAn Modular Workflow** is an alternative approach to running PEcAn models directly in R, rather than using the web interface. PEcAn (Predictive Ecosystem Analyzer) automates ecological modeling, allowing researchers to analyze plant functional traits, execute model simulations, and perform sensitivity analyses. 

This modular workflow provides more flexibility by allowing users to run specific steps of the workflow independently, rather than executing the entire process at once. It is particularly useful for advanced users who want more control over individual components of the modeling pipeline.

Instead of relying on the web interface, users can configure their workflow using a `pecan.xml` file and execute it directly in RStudio. This enables reproducibility and efficient debugging of individual workflow steps.

To use the modular workflow, open **RStudio** in your local machine.

Then, navigate to `web/workflow.Rmd` and open it to run the workflow. Once `pecan.xml` is correctly configured, this approach eliminates the need for executing workflows via the web interface.


## Why Use the Modular Workflow?

The current PEcAn workflow (workflow.R) is monolithic, making it less flexible for different user needs. The modular workflow approach breaks it into smaller, independent components, enabling greater adaptability. 

Instead of running the entire workflow at once, users can:
- Execute specific workflow steps using API endpoints.
- Run only the necessary components, such as **run.write.configs** or **start_model_runs**.
- Process meteorology, soils, initial conditions, phenology, and parameter files separately.

This modular approach improves usability, debugging, and automation, making PEcAn workflows more efficient.

## How to Generate a `pecan.xml` File

To obtain a `pecan.xml` file while running a workflow in the PEcAn web interface, follow these steps:

1. Execute the workflow in the PEcAn web interface.
2. Once the workflow runs successfully, download the `pecan.xml` file from the web interface.
3. After configuring your settings, click on **Edit pecan.xml** to modify the file as needed.

For a detailed step-by-step tutorial, refer to the official documentation:  
[PEcAn Workflow Tutorial](https://pecanproject.github.io/pecan-documentation/tutorials/Demo01.html).


### Example pecan.xml File

If you follow the steps outlined in the PEcAn Basic Workflow section, you will generate a `pecan.xml` file similar to the example below:

```xml
<?xml version="1.0"?>
<pecan>
  <info>
    <notes></notes>
    <userid>-1</userid>
    <username></username>
    <date>2025/03/24 10:37:56 +0000</date>
  </info>
  <outdir>/data/workflows/PEcAn_99000000005</outdir>
  <database>
    <bety>
      <user>bety</user>
      <password>bety</password>
      <host>postgres</host>
      <port>5432</port>
      <dbname>bety</dbname>
      <driver>PostgreSQL</driver>
      <write>true</write>
    </bety>
    <dbfiles>/data/dbfiles</dbfiles>
  </database>
  <pfts>
    <pft>
      <name>temperate.coniferous</name> 
    </pft>
  </pfts>
  <meta.analysis>
    <iter>3000</iter>
    <random.effects>
      <on>FALSE</on>
      <use_ghs>TRUE</use_ghs>
    </random.effects>
  </meta.analysis>
  <ensemble>
    <size>1</size>
    <variable>NPP</variable>
    <samplingspace>
      <parameters>
        <method>uniform</method>
      </parameters>
      <met>
        <method>sampling</method>
      </met>
    </samplingspace>
  </ensemble>
  <model>
    <id>99000000003</id>
  </model>
  <workflow>
    <id>99000000005</id>
  </workflow>
  <run>
    <site>
      <id>772</id>
      <met.start>2004/01/01</met.start>
      <met.end>2004/12/31</met.end>
    </site>
    <inputs>
      <met>
        <source>AmerifluxLBL</source>
        <output>SIPNET</output>
        <username>Aritra_2023</username>
      </met>
    </inputs>
    <start.date>2004/01/01</start.date>
    <end.date>2004/12/31</end.date>
  </run>
  <host>
    <name>localhost</name>
    <rabbitmq>
      <uri>amqp://guest:guest@rabbitmq/%2F</uri>
      <queue>SIPNET_git</queue>
    </rabbitmq>
  </host>
</pecan>
```


# Prerequisites
Before running this workflow, ensure you have:

- An XML settings file (`pecan.xml`) 
- A model binary (e.g., **SIPNET**) specified in your settings.
- A pecan repository cloned from GitHub(https://github.com/pecanproject/pecan) in rstudiio.If you are using docker to set up pecan no need to clone pecan repo.

